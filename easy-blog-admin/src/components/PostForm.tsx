"use client";

import { useState, useEffect } from "react";
import { Form, Input, Select, Button, Card, message, Space, Tooltip } from "antd";
import {
  SaveOutlined,
  SendOutlined,
  FileTextOutlined,
  StarOutlined,
} from "@ant-design/icons";
import PostEditorWrapper from "./PostEditorWrapper";
import { Post, Category, Tag } from "@/types";
import aiWritingApi from "@/api/ai-writing";
import { getErrorMessage, isRetryable } from "@/utils/error-handler";

// è¡¨å•å­—æ®µç±»å‹å®šä¹‰
interface PostFormValues {
  title: string;
  slug: string;
  summary?: string;
  coverImage?: string;
  categoryIds: string[];
  tagIds: string[];
  status: "DRAFT" | "PUBLISHED" | "ARCHIVED";
}

interface PostFormProps {
  post?: Post;
  categories: Category[];
  tags: Tag[];
  onSubmit: (values: Partial<Post>) => Promise<void>;
  onSaveDraft?: (values: Partial<Post>) => Promise<void>;
  onPreview?: (values: Partial<Post>) => void;
  loading?: boolean;
  showActions?: boolean;
}

export default function PostForm({
  post,
  categories,
  tags,
  onSubmit,
  onSaveDraft,
  onPreview,
  loading,
  showActions = true,
}: PostFormProps) {
  const [form] = Form.useForm<PostFormValues>();
  const [content, setContent] = useState(post?.content || "");
  const [isDraftSaving, setIsDraftSaving] = useState(false);
  const [isSlugAutoGenerated, setIsSlugAutoGenerated] = useState(false);
  const [titleGenerating, setTitleGenerating] = useState(false);
  const [summaryGenerating, setSummaryGenerating] = useState(false);

  const handleSubmit = async (values: PostFormValues) => {
    try {
      await onSubmit({
        ...values,
        content,
      });
      message.success(post ? "æ–‡ç« æ›´æ–°æˆåŠŸ" : "æ–‡ç« åˆ›å»ºæˆåŠŸ");
    } catch (error: unknown) {
      message.error(error instanceof Error ? error.message : "æ“ä½œå¤±è´¥");
    }
  };

  const handleSaveDraft = async () => {
    if (!onSaveDraft) return;

    setIsDraftSaving(true);
    try {
      const values = await form.validateFields();
      await onSaveDraft({
        ...values,
        content,
        status: "DRAFT",
      });
      message.success("è‰ç¨¿ä¿å­˜æˆåŠŸ");
    } catch (error: unknown) {
      if (error instanceof Error) {
        message.error(error.message);
      }
    } finally {
      setIsDraftSaving(false);
    }
  };

  const handlePreview = async () => {
    if (!onPreview) return;

    try {
      const values = await form.validateFields();
      onPreview({
        ...values,
        content,
      });
    } catch (error: unknown) {
      if (error instanceof Error) {
        message.error(error.message);
      }
    }
  };

  const generateSlug = (title: string) => {
    return title
      .toLowerCase()
      .replace(/[^\w\s-]/g, "")
      .replace(/[\s_-]+/g, "-")
      .replace(/^-+|-+$/g, "");
  };

  const handleTitleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const title = e.target.value;
    // åªæœ‰åœ¨slugæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„æƒ…å†µä¸‹æ‰æ›´æ–°slug
    if (isSlugAutoGenerated) {
      const slug = generateSlug(title);
      form.setFieldsValue({ slug });
    }
  };

  const handleSlugChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const slug = e.target.value;
    // å¦‚æœç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº†slugï¼Œåˆ™æ ‡è®°ä¸ºéè‡ªåŠ¨ç”Ÿæˆ
    if (slug !== generateSlug(form.getFieldValue("title"))) {
      setIsSlugAutoGenerated(false);
    }
  };

  const handleSlugFocus = () => {
    // å½“ç”¨æˆ·èšç„¦åˆ°slugå­—æ®µæ—¶ï¼Œå¦‚æœslugæ˜¯ç©ºçš„ï¼Œåˆ™è‡ªåŠ¨ç”Ÿæˆ
    const currentSlug = form.getFieldValue("slug");
    const currentTitle = form.getFieldValue("title");
    if (!currentSlug && currentTitle) {
      const slug = generateSlug(currentTitle);
      form.setFieldsValue({ slug });
      setIsSlugAutoGenerated(true);
    }
  };

  // AIç”Ÿæˆæ ‡é¢˜
  const handleGenerateTitle = async () => {
    const currentContent = content || form.getFieldValue("summary") || "";
    if (!currentContent || currentContent.trim().length === 0) {
      message.warning("è¯·å…ˆè¾“å…¥æ–‡ç« å†…å®¹æˆ–æ‘˜è¦");
      return;
    }

    setTitleGenerating(true);
    try {
      const title = await aiWritingApi.generateTitle({ content: currentContent });
      form.setFieldsValue({ title });
      message.success("æ ‡é¢˜ç”ŸæˆæˆåŠŸ");
    } catch (error: any) {
      const errorMsg = getErrorMessage(error);
      const retryable = isRetryable(error);
      message.error({
        content: errorMsg,
        duration: retryable ? 5 : 3,
      });
    } finally {
      setTitleGenerating(false);
    }
  };

  // AIç”Ÿæˆæ‘˜è¦
  const handleGenerateSummary = async () => {
    const currentContent = content;
    if (!currentContent || currentContent.trim().length === 0) {
      message.warning("è¯·å…ˆè¾“å…¥æ–‡ç« å†…å®¹");
      return;
    }

    setSummaryGenerating(true);
    try {
      const summary = await aiWritingApi.generateSummary({
        content: currentContent,
        maxLength: 200,
      });
      form.setFieldsValue({ summary });
      message.success("æ‘˜è¦ç”ŸæˆæˆåŠŸ");
    } catch (error: any) {
      const errorMsg = getErrorMessage(error);
      const retryable = isRetryable(error);
      message.error({
        content: errorMsg,
        duration: retryable ? 5 : 3,
      });
    } finally {
      setSummaryGenerating(false);
    }
  };

  useEffect(() => {
    if (post) {
      // è½¬æ¢åç«¯æ•°æ®æ ¼å¼ä¸ºå‰ç«¯æœŸæœ›çš„æ ¼å¼
      const categoryIds = post.categories?.map((cat) => cat.id) || [];
      const tagIds = post.tags?.map((tag) => tag.id) || [];

      form.setFieldsValue({
        title: post.title,
        slug: post.slug,
        summary: post.summary,
        coverImage: post.coverImage,
        status: post.status,
        categoryIds: categoryIds,
        tagIds: tagIds,
      });
      setContent(post.content);
      // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œslugä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„
      setIsSlugAutoGenerated(false);
    } else {
      // åˆ›å»ºæ¨¡å¼ä¸‹ï¼Œåˆå§‹æ—¶slugæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„
      setIsSlugAutoGenerated(true);
    }
  }, [post, form]);

  return (
    <div className="space-y-6">
      {/* è¡¨å•å¤´éƒ¨ - ç§»é™¤ï¼Œå› ä¸ºå·²ç»åœ¨é¡µé¢çº§åˆ«å¤„ç† */}

      <Form
        form={form}
        layout="vertical"
        onFinish={handleSubmit}
        initialValues={{
          status: "DRAFT",
          categoryIds: [],
          tagIds: [],
        }}
        className="space-y-6"
      >
        {/* åŸºæœ¬ä¿¡æ¯ */}
        <Card
          title={
            <div className="flex items-center space-x-2">
              <div className="w-5 h-5 bg-blue-100 rounded flex items-center justify-center">
                <FileTextOutlined className="text-blue-600 text-xs" />
              </div>
              <span className="text-gray-900 font-medium">åŸºæœ¬ä¿¡æ¯</span>
            </div>
          }
          size="small"
          className="shadow-sm border-0"
          styles={{
            header: {
              backgroundColor: "#f8fafc",
              borderBottom: "1px solid #e2e8f0",
              padding: "16px 20px",
            },
            body: {
              padding: "20px",
            },
          }}
        >
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <Form.Item
              label={
                <span className="text-gray-700 font-medium">
                  æ–‡ç« æ ‡é¢˜ <span className="text-red-500">*</span>
                </span>
              }
              name="title"
              rules={[{ required: true, message: "è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜" }]}
            >
              <Space.Compact className="w-full" size="large">
                <Input
                  placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜"
                  onChange={handleTitleChange}
                  size="large"
                  className="rounded-l-lg"
                />
                <Tooltip title="æ ¹æ®æ–‡ç« å†…å®¹æˆ–æ‘˜è¦è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜">
                  <Button
                    type="default"
                    icon={<StarOutlined />}
                    onClick={handleGenerateTitle}
                    loading={titleGenerating}
                    size="large"
                    className="rounded-r-lg border-l-0 hover:bg-blue-50"
                  >
                    AI
                  </Button>
                </Tooltip>
              </Space.Compact>
            </Form.Item>

            <Form.Item
              label={
                <span className="text-gray-700 font-medium">
                  URL åˆ«å <span className="text-red-500">*</span>
                </span>
              }
              name="slug"
              rules={[{ required: true, message: "è¯·è¾“å…¥ URL åˆ«å" }]}
            >
              <Space.Compact className="w-full" size="large">
                <Input
                  size="large"
                  placeholder="è¯·è¾“å…¥ URL åˆ«å"
                  onChange={handleSlugChange}
                  onFocus={handleSlugFocus}
                  className="rounded-l-lg"
                />
                <span
                  className={`px-3 flex items-center text-xs border border-l-0 rounded-r-lg ${
                    isSlugAutoGenerated
                      ? "text-gray-500 bg-gray-100 border-gray-200"
                      : "text-blue-500 bg-blue-50 border-blue-200"
                  }`}
                >
                  {isSlugAutoGenerated ? "è‡ªåŠ¨ç”Ÿæˆ" : "æ‰‹åŠ¨ç¼–è¾‘"}
                </span>
              </Space.Compact>
            </Form.Item>
          </div>

          <Form.Item
            label={
              <div className="flex items-center justify-between w-full">
                <span className="text-gray-700 font-medium">æ–‡ç« æ‘˜è¦</span>
                <Tooltip title="æ ¹æ®æ–‡ç« å†…å®¹è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦">
                  <Button
                    type="link"
                    icon={<StarOutlined />}
                    onClick={handleGenerateSummary}
                    loading={summaryGenerating}
                    size="small"
                    className="p-0"
                  >
                    AIç”Ÿæˆæ‘˜è¦
                  </Button>
                </Tooltip>
              </div>
            }
            name="summary"
          >
            <Input.TextArea
              placeholder="è¯·è¾“å…¥æ–‡ç« æ‘˜è¦ï¼Œå¸®åŠ©è¯»è€…å¿«é€Ÿäº†è§£æ–‡ç« å†…å®¹"
              rows={3}
              showCount
              maxLength={200}
              className="rounded-lg"
            />
          </Form.Item>

          <Form.Item
            label={<span className="text-gray-700 font-medium">å°é¢å›¾ç‰‡</span>}
            name="coverImage"
          >
            <Input placeholder="è¯·è¾“å…¥å°é¢å›¾ç‰‡ URL" className="rounded-lg" />
          </Form.Item>
        </Card>

        {/* åˆ†ç±»å’Œæ ‡ç­¾ */}
        <Card
          title={
            <div className="flex items-center space-x-2">
              <div className="w-5 h-5 bg-green-100 rounded flex items-center justify-center">
                <span className="text-green-600 text-xs">ğŸ·ï¸</span>
              </div>
              <span className="text-gray-900 font-medium">åˆ†ç±»å’Œæ ‡ç­¾</span>
            </div>
          }
          size="small"
          className="shadow-sm border-0"
          styles={{
            header: {
              backgroundColor: "#f8fafc",
              borderBottom: "1px solid #e2e8f0",
              padding: "16px 20px",
            },
            body: {
              padding: "20px",
            },
          }}
        >
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <Form.Item
              label={
                <span className="text-gray-700 font-medium">æ–‡ç« åˆ†ç±»</span>
              }
              name="categoryIds"
            >
              <Select
                mode="multiple"
                placeholder="è¯·é€‰æ‹©æ–‡ç« åˆ†ç±»"
                className="rounded-lg"
                options={categories.map((cat) => ({
                  label: (
                    <div className="flex items-center space-x-2">
                      {cat.color && (
                        <div
                          className="w-3 h-3 rounded-full"
                          style={{ backgroundColor: cat.color }}
                        />
                      )}
                      <span>{cat.name}</span>
                    </div>
                  ),
                  value: cat.id,
                }))}
              />
            </Form.Item>

            <Form.Item
              label={
                <span className="text-gray-700 font-medium">æ–‡ç« æ ‡ç­¾</span>
              }
              name="tagIds"
            >
              <Select
                mode="multiple"
                placeholder="è¯·é€‰æ‹©æ–‡ç« æ ‡ç­¾"
                className="rounded-lg"
                options={tags.map((tag) => ({
                  label: (
                    <div className="flex items-center space-x-2">
                      {tag.color && (
                        <div
                          className="w-3 h-3 rounded-full"
                          style={{ backgroundColor: tag.color }}
                        />
                      )}
                      <span>{tag.name}</span>
                    </div>
                  ),
                  value: tag.id,
                }))}
              />
            </Form.Item>
          </div>
        </Card>

        {/* å‘å¸ƒè®¾ç½® */}
        <Card
          title={
            <div className="flex items-center space-x-2">
              <div className="w-5 h-5 bg-purple-100 rounded flex items-center justify-center">
                <span className="text-purple-600 text-xs">âš™ï¸</span>
              </div>
              <span className="text-gray-900 font-medium">å‘å¸ƒè®¾ç½®</span>
            </div>
          }
          size="small"
          className="shadow-sm border-0"
          styles={{
            header: {
              backgroundColor: "#f8fafc",
              borderBottom: "1px solid #e2e8f0",
              padding: "16px 20px",
            },
            body: {
              padding: "20px",
            },
          }}
        >
          <Form.Item
            label={
              <span className="text-gray-700 font-medium">
                å‘å¸ƒçŠ¶æ€ <span className="text-red-500">*</span>
              </span>
            }
            name="status"
            rules={[{ required: true, message: "è¯·é€‰æ‹©æ–‡ç« çŠ¶æ€" }]}
          >
            <Select className="rounded-lg">
              <Select.Option value="DRAFT">
                <div className="flex items-center space-x-2">
                  <div className="w-2 h-2 bg-orange-400 rounded-full"></div>
                  <span>è‰ç¨¿</span>
                </div>
              </Select.Option>
              <Select.Option value="PUBLISHED">
                <div className="flex items-center space-x-2">
                  <div className="w-2 h-2 bg-green-400 rounded-full"></div>
                  <span>å·²å‘å¸ƒ</span>
                </div>
              </Select.Option>
              <Select.Option value="ARCHIVED">
                <div className="flex items-center space-x-2">
                  <div className="w-2 h-2 bg-gray-400 rounded-full"></div>
                  <span>å·²å½’æ¡£</span>
                </div>
              </Select.Option>
            </Select>
          </Form.Item>
        </Card>

        {/* æ–‡ç« å†…å®¹ */}
        <Card
          title={
            <div className="flex items-center space-x-2">
              <div className="w-5 h-5 bg-indigo-100 rounded flex items-center justify-center">
                <span className="text-indigo-600 text-xs">âœï¸</span>
              </div>
              <span className="text-gray-900 font-medium">æ–‡ç« å†…å®¹</span>
            </div>
          }
          size="small"
          className="shadow-sm border-0"
          styles={{
            header: {
              backgroundColor: "#f8fafc",
              borderBottom: "1px solid #e2e8f0",
              padding: "16px 20px",
            },
            body: {
              padding: "20px",
            },
          }}
        >
          <Form.Item
            name="content"
            rules={[{ required: true, message: "è¯·è¾“å…¥æ–‡ç« å†…å®¹" }]}
          >
            <PostEditorWrapper
              content={content}
              onChange={setContent}
              placeholder="è¯·è¾“å…¥æ–‡ç« å†…å®¹..."
            />
          </Form.Item>
        </Card>

        {/* æäº¤æŒ‰é’® */}
        {showActions && (
          <Card
            size="small"
            className="shadow-sm border-0 bg-gradient-to-r from-blue-50 to-indigo-50"
            styles={{
              body: { padding: "20px" },
            }}
          >
            <div className="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4">
              <div className="text-sm text-gray-600">
                <span className="font-medium">æç¤ºï¼š</span>
                å¯ä»¥å…ˆä¿å­˜è‰ç¨¿ï¼Œç¨åç»§ç»­ç¼–è¾‘å’Œå‘å¸ƒ
              </div>
              <Space size="middle">
                <Button
                  type="default"
                  icon={<SaveOutlined />}
                  onClick={handleSaveDraft}
                  loading={isDraftSaving}
                  disabled={!content.trim()}
                  size="large"
                  className="rounded-lg border-gray-300 hover:border-blue-400"
                >
                  ä¿å­˜è‰ç¨¿
                </Button>
                <Button
                  type="primary"
                  icon={<SendOutlined />}
                  htmlType="submit"
                  loading={loading}
                  size="large"
                  className="rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 border-0 shadow-lg hover:shadow-xl"
                >
                  {post ? "æ›´æ–°æ–‡ç« " : "å‘å¸ƒæ–‡ç« "}
                </Button>
              </Space>
            </div>
          </Card>
        )}
      </Form>
    </div>
  );
}
